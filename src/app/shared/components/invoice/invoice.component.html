<div class="container">
  <h2 mat-dialog-title>ایجاد فاکتور</h2>

  <form [formGroup]="invoiceForm" mat-dialog-content>
    <mat-form-field>
      <mat-label>مشتری</mat-label>
      <mat-select formControlName="customer">
        <mat-option *ngFor="let person of people" [value]="person">{{ person.FirstName }} {{ person.LastName }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>محصول</mat-label>
      <mat-select formControlName="product" (selectionChange)="updateProductDetails()">
        <mat-option *ngFor="let product of products" [value]="product">{{ product.Name }}</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Show product details only if there are more than one -->
    <div *ngIf="selectedProductDetails.length > 0">
      <mat-form-field>
        <mat-label>جزئیات محصول</mat-label>
        <mat-select formControlName="productDetail" (selectionChange)="onProductDetailChange()">
          <mat-option *ngFor="let detail of selectedProductDetails" [value]="detail">{{ getProductDetailDescription(detail) }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Show product properties only if there are properties available -->
    <div *ngIf="selectedProductProperties.length > 0">
      <mat-form-field>
        <mat-label>ویژگی محصول</mat-label>
        <mat-select formControlName="productProperty" (selectionChange)="onProductPropertyChange()">
          <mat-option *ngFor="let detail of selectedProductDetails" [value]="parseProperties(detail.Properties)">
            {{ parseProperties(detail.Properties) }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    

    <mat-form-field>
      <mat-label>قیمت</mat-label>
      <mat-select formControlName="price">
        <mat-option *ngFor="let price of productPrices" [value]="price">{{ price | rialCurrency }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>تعداد</mat-label>
      <input matInput type="number" formControlName="quantity">
    </mat-form-field>

    <div class="form-group row">
      <div class="col-sm-10 offset-sm-2">
        <button mat-raised-button color="primary" type="button" (click)="addItemToInvoice()">افزودن به سبد خرید</button>
      </div>
    </div>
  </form>

  <div *ngIf="invoiceItems.length > 0">
    <h3>موارد فاکتور</h3>
    <table class="table">
      <thead>
        <tr>
          <th>محصول</th>
          <th>تعداد</th>
          <th>قیمت</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of invoiceItems; let i = index">
          <td class="align-right">{{ getProductName(item.ProductDetailId) }}</td>
          <td class="align-right">{{ item.Count1 }}</td>
          <td class="align-right">{{ item.Price | rialCurrency }}</td>
          <td><button class="btn btn-danger" (click)="removeItemFromInvoice(i)">حذف</button></td>
        </tr>
      </tbody>
    </table>

    <div class="total-section">
      <p>جمع جزء: <span>{{ subtotal | rialCurrency }}</span></p>
      <p>مالیات ({{ (taxRate * 100) }}%): <span>{{ subtotal * taxRate | rialCurrency }}</span></p>
      <p>جمع کل: <span>{{ total | rialCurrency }}</span></p>
    </div>
  </div>

  <div class="form-group row">
    <div class="col-sm-10 offset-sm-2">
      <button mat-raised-button color="accent" (click)="submitInvoice()">ثبت فاکتور</button>
      <button mat-raised-button color="warn" (click)="resetInvoice()">بازنشانی</button>
    </div>
  </div>
</div>
