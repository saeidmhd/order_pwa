<div class="container">
  <h2 class="invoice-title">ایجاد فاکتور</h2>

  <form [formGroup]="invoiceForm" class="invoice-form">
    <mat-form-field class="full-width">
      <mat-label>مشتری</mat-label>
      <mat-select formControlName="customer" (selectionChange)="updateProductDetails()">
        <mat-option *ngFor="let person of people" [value]="person">{{ person.FirstName }} {{ person.LastName }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field class="full-width">
      <mat-label>محصول</mat-label>
      <mat-select formControlName="product" (selectionChange)="updateProductDetails()">
        <mat-option *ngFor="let product of products" [value]="product">{{ product.Name }}</mat-option>
      </mat-select>
    </mat-form-field>

    <div *ngIf="selectedProductDetails.length > 0">
      <mat-form-field class="full-width">
        <mat-label>جزئیات محصول</mat-label>
        <mat-select formControlName="productDetail" (selectionChange)="onProductDetailChange()">
          <mat-option *ngFor="let detail of selectedProductDetails" [value]="detail">{{ getProductDetailDescription(detail) }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div *ngIf="selectedProductProperties.length > 0">
      <mat-form-field class="full-width">
        <mat-label>ویژگی محصول</mat-label>
        <mat-select formControlName="productProperty" (selectionChange)="onProductPropertyChange()">
          <mat-option *ngFor="let detail of selectedProductDetails" [value]="parseProperties(detail.Properties)">
            {{ parseProperties(detail.Properties) }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field class="half-width">
        <mat-label>قیمت</mat-label>
        <mat-select formControlName="price">
          <mat-option *ngFor="let price of productPrices" [value]="price">{{ price | rialCurrency }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field class="half-width">
        <mat-label>تعداد</mat-label>
        <input matInput type="number" formControlName="quantity">
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field class="half-width">
        <mat-label>نوع تخفیف</mat-label>
        <mat-select formControlName="discountType">
          <mat-option [value]="0">مبلغی</mat-option>
          <mat-option [value]="1">درصدی</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field class="half-width">
        <mat-label>مقدار تخفیف</mat-label>
        <input matInput type="number" formControlName="discount">
      </mat-form-field>
    </div>

    <div class="button-row">
      <button mat-raised-button color="primary" type="button" (click)="addItemToInvoice()">افزودن به سبد خرید</button>
    </div>
  </form>

<div *ngIf="invoiceItems.length > 0" class="invoice-items">
  <h3>موارد فاکتور</h3>
  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th>شرح کالا / درآمد</th>
          <th>مقدار</th>
          <th>فی</th>
          <th>تخفیف</th>
          <th>مبلغ خالص</th>
          <th>عوارض و مالیات</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of invoiceItems; let i = index">
          <td>{{ getProductName(item.ProductDetailId) }}</td>
          <td>{{ item.Count1 }}</td>
          <td>{{ item.UnitPrice | rialCurrency }}</td>
          <td>{{ item.Discount | rialCurrency }}</td>
          <td>{{ item.Price | rialCurrency }}</td>
          <td>{{ (item.Price * (item.TaxPercent + item.ChargePercent)) | rialCurrency }}</td>
          <td><button mat-icon-button color="warn" (click)="removeItemFromInvoice(i)"><mat-icon>delete</mat-icon></button></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="total-section">
    <p>جمع جزء: <span>{{ subtotal | rialCurrency }}</span></p>
    <p>تخفیف: <span>{{ discountValue | rialCurrency }}</span></p>
    <p>مالیات: <span>{{ totalTax | rialCurrency }}</span></p>
    <p>عوارض: <span>{{ totalCharge | rialCurrency }}</span></p>
    <p>جمع کل: <span>{{ total | rialCurrency }}</span></p>
  </div>

  <div class="button-row">
    <button mat-raised-button color="accent" (click)="submitInvoice()">ثبت فاکتور</button>
    <button mat-raised-button color="warn" (click)="resetInvoice()">بازنشانی</button>
  </div>
</div>